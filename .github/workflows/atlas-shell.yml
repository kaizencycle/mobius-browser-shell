name: ATLAS-SHELL Sentinel

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Sentinel mode (review / health / consensus)'
        required: false
        default: 'review'

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  atlas-shell-review:
    name: "⬡ ATLAS-SHELL Constitutional Review"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install anthropic requests PyGithub

      - name: Get PR diff
        id: diff
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
          echo "PR diff captured: $(wc -l < /tmp/pr.diff) lines"

      - name: Get branch diff (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git diff main...HEAD > /tmp/pr.diff || git diff main > /tmp/pr.diff || echo "" > /tmp/pr.diff
          echo "Branch diff captured: $(wc -l < /tmp/pr.diff) lines"

      - name: Run ATLAS-SHELL Review
        id: atlas_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          MOBIUS_ATLAS_REPO: "kaizencycle/Mobius-Systems"
          SENTINEL_ID: "atlas-shell"
        run: python sentinel/atlas_shell.py review

      - name: Post Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '';
            try {
              comment = fs.readFileSync('/tmp/atlas_review.md', 'utf8');
            } catch (e) {
              comment = '## ⬡ ATLAS-SHELL Constitutional Review\n\n*Review output unavailable.*';
            }
            
            // Find and update existing ATLAS-SHELL comment, or create new one
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existing = comments.data.find(c => 
              c.body.includes('⬡ ATLAS-SHELL') && 
              c.user.login === 'github-actions[bot]'
            );
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

      - name: Create Check Run
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let score = 75; // default
            try {
              score = parseInt(fs.readFileSync('/tmp/atlas_score.txt', 'utf8').trim());
            } catch(e) {}
            
            const conclusion = score >= 60 ? 'success' : 'neutral';
            const title = score >= 80 
              ? `⬡ Ratified (${score}/100)` 
              : score >= 60 
                ? `⬡ Passed with notes (${score}/100)`
                : `⬡ Concern flagged (${score}/100)`;
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ATLAS-SHELL Constitutional Review',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: `ATLAS-SHELL covenant score: ${score}/100. See PR comment for full assessment.`,
              }
            });

  atlas-shell-deployment:
    name: "⬡ ATLAS-SHELL Deployment Monitor"
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic requests PyGithub

      - name: Monitor Deployment
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: python sentinel/atlas_shell.py deployment
